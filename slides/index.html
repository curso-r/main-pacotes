<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Pacotes üì¶</title>
    <meta charset="utf-8" />
    <meta name="author" content="" />
    <script src="libs/header-attrs-2.7.8/header-attrs.js"></script>
    <link rel="stylesheet" href="css/xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Pacotes üì¶
### <img src = 'https://d33wubrfki0l68.cloudfront.net/9b0699f18268059bdd2e5c21538a29eade7cbd2b/67e5c/img/logo/cursor1-5.png' width = '30%'>

---




# Sum√°rio

1. Sobre a Curso-R

1. Sobre o curso

1. Preparando o ambiente de desenvolvimento

1. Fundamentos de desenvolvimento de pacotes em R

1. Documenta√ß√£o

1. Testes unit√°rios e consist√™ncia de c√≥digo

1. Disponibilizando seu pacote

---
class: middle, center, inverse
# Sobre a Curso-R

---
# A empresa

.pull-left[
&lt;img src="https://d33wubrfki0l68.cloudfront.net/295643c6243701ae6a9bac3fb8ad467ff0ce3c84/d1785/img/logo/cursor1-41.png" width="80%" style="display: block; margin: auto;" /&gt;

&lt;br&gt;
&lt;br&gt;

&lt;img src="img/logo_r6.png" width="1344" style="display: block; margin: auto;" /&gt;
]

.pull-right[
&lt;img src="img/produtos.png" width="80%" style="display: block; margin: auto;" /&gt;
]

---
# Ministrantes

.pull-left[
## Caio Lente
&lt;img src="img/caio.jpeg" width="40%" style="display: block; margin: auto;" /&gt;

Mestrando em Ci√™ncia da Computa√ß√£o no IME-USP e cientista de dados na Terranova Consultoria. Programador desde os 15 anos, come√ßou a se apaixonar pelo R em 2016 e agora n√£o fala em outra coisa. Metido a designer, man√≠aco da organiza√ß√£o e metade texano.
]

.pull-right[
## Beatriz Milz
&lt;img src="img/bea.jpg" width="40%" style="display: block; margin: auto;" /&gt;

Doutoranda em Ci√™ncia Ambiental (PROCAM/IEE/USP) na Universidade de S√£o Paulo. Co-organizadora da [R-Ladies S√£o Paulo](https://www.meetup.com/R-Ladies-Sao-Paulo/). Instrutora da [Carpentries](https://carpentries.org/instructors/), um projeto que tem como miss√£o ensinar habilidades de ci√™ncia de dados para pessoas pesquisadoras. Instrutora de tidyverse [certificada pela RStudio](https://education.rstudio.com/trainers/people/milz+beatriz/). 
]

---
# Linha do tempo

&lt;img src="img/linha_do_tempo.png" width="35%" style="display: block; margin: auto;" /&gt;

---
# Nossos cursos

.pull-left[
&lt;div class="container center"&gt;
  &lt;div class="card"&gt;
    &lt;h2&gt;Programa√ß√£o em R&lt;/h2&gt;
    &lt;hr style = "background-color: #3bb44a;"/&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/intro-programacao/"&gt;Introdu√ß√£o √† programa√ß√£o com R&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/r4ds-1/"&gt;R para Ci√™ncia de dados I&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/r4ds-2/"&gt;R para Ci√™ncia de dados II&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/pacotes/"&gt;Pacotes&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/rcpp/"&gt;Introdu√ß√£o ao R com C++&lt;/a&gt;&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;br&gt;
&lt;div class="container center"&gt;
  &lt;div class="card"&gt;
    &lt;h2&gt;Extra√ß√£o de dados&lt;/h2&gt;
    &lt;hr style = "background-color: #eeba30;"/&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/faxina/"&gt;Faxina de dados&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/web-scraping/"&gt;Web scraping&lt;/a&gt;&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
]

.pull-right[
&lt;div class="container center"&gt;
  &lt;div class="card"&gt;
    &lt;h2&gt;Modelagem&lt;/h2&gt;
    &lt;hr style = "background-color: #996699;"/&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/regressao-linear/"&gt;Regress√£o Linear&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/intro-machine-learning/"&gt;Machine Learning&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/xgboost/"&gt;XGBoost&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/deep-learning/"&gt;Deep Learning&lt;/a&gt;&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;br&gt;&lt;br&gt; 
&lt;div class="container center"&gt;
  &lt;div class="card"&gt;
    &lt;h2&gt;Comunica√ß√£o e automa√ß√£o&lt;/h2&gt;
    &lt;hr style = "background-color: #ff6699;"/&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/dashboards/"&gt;Relat√≥rios e visualiza√ß√£o de dados&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/dashboards/"&gt;Dashboards com R&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;a href = "https://www.curso-r.com/cursos/deploy/"&gt;Deploy&lt;/a&gt;&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
]

---
class: middle, center, inverse
# Sobre o curso

---
# Informa√ß√µes gerais

- As aulas v√£o das 9:00 √†s 13:00, com uma pausa de 10 min em torno das 11:00

- As aulas ser√£o gravadas e disponibilizadas no Google Classroom

- Podem mandar d√∫vidas no chat do Zoom ou abrir o microfone para perguntar

- Teremos bastante exerc√≠cios para resolver durante o workshop, ent√£o se prepare!

### Informa√ß√µes de voc√™s

- N√≥s gostar√≠amos de saber sobre voc√™s (**escreva no chat**):

  1. Qual √© o seu nome?

  1. Com o que voc√™ trabalha?

  1. Qual √© o seu pacote favorito?

  1. Como imagina usar pacotes no futuro?

---
# Pratique

- N√£o se preocupe com estilos de estudo. Use o que te deixar mais confort√°vel.

- Estude um pouco todo dia. Se voc√™ tem apenas uma hora para estudar na semana, fa√ßa 3 sess√µes de 20 minutos em dias diferentes.

- Se teste! Coloque em pr√°tica o que voc√™ aprendeu resolvendo exerc√≠cios ou inserindo o R no seu dia-a-dia.

.footnote[[Nahurhodo 205 - Powerpoint √© √∫til para a aprendizagem?](https://www.b9.com.br/shows/naruhodo/naruhodo-205-powerpoint-e-util-para-a-aprendizagem/)]

---
# Tirando d√∫vidas

- **N√£o existe d√∫vida idiota**

- Fora do hor√°rio de aula ou monitoria:

  - perguntas gerais sobre o curso dever√£o ser feitas no Classroom
  
  - perguntas sobre R, principalmente as que envolverem c√≥digo, dever√£o ser enviadas no [nosso discourse](https://discourse.curso-r.com/)

- [Veja aqui dicas de como fazer uma boa pergunta](https://discourse.curso-r.com/t/como-escrever-uma-boa-pergunta/542)

### Por que usar o discourse?

- Muito melhor para escrever textos que possuem c√≥digos. Com ele, podemos usar o pacote `{reprex}`!

- Saber pesquisar sobre erros e fazer a pergunta certa √© essencial para aprender e resolver problemas de programa√ß√£o

- No discourse, teremos mais pessoas acompanhando e respondendo as d√∫vidas

- Em um ambiente aberto, as suas d√∫vidas v√£o contribuir com a comunidade

---
class: middle, center, inverse
# Preparando o ambiente de desenvolvimento

---
# Check-list antes de come√ßar a aula

- [R](https://livro.curso-r.com/1-1-instalacao-do-r.html) e [RStudio](https://livro.curso-r.com/1-1-instalacao-do-r.html) instalados

- [Ferramentas de desenvolvimento](https://r-pkgs.org/setup.html#setup-tools):

  - Windows: [RTools instalado](https://livro.curso-r.com/1-3-instalacao-adicionais.html#rtools)
  
  - Linux: [r-base-dev](https://livro.curso-r.com/1-3-instalacao-adicionais.html#rtools)
  
  - MacOS: Xcode command line tools


```r
devtools::has_devel()
```

```
#&gt; Your system is ready to build packages!
```

- [Pacotes necess√°rios instalados](https://github.com/curso-r/main-pacotes#pacotes-necess%C3%A1rios)

- [Git instalado](https://git-scm.com/)

- [Conta no GitHub criada](https://github.com/)

---
class: middle, center, inverse
# .RData e .Rhistory

---
# Os arquivos .RData e .Rhistory 

Em sua configura√ß√£o padr√£o, a IDE manter√° na "mem√≥ria" todos os √∫ltimos comandos executados, todos os dados utilizados e todos os objetos criados.

Ao fechar e abrir o RStudio, essas informa√ß√µes ser√£o recarregadas na mem√≥ria como se o usu√°rio nunca tivesse sa√≠do do programa. Esse recurso √© tornado poss√≠vel pela cria√ß√£o de dois arquivos ocultos: `.RData` e `.Rhistory`.

O primeiro abriga absolutamente todos os objetos criados por uma sess√£o R, enquanto o segundo cont√©m uma lista com os √∫ltimos comandos executados. 

Ao reabrir o RStudio, o conte√∫do armazenados nestes arquivos ser√° carregado no ambiente de trabalho atual como se nada tivesse acontecido.

.footnote[Leia mais [neste cap√≠tulo do livro Zen do R](https://curso-r.github.io/zen-do-r/rdata-rhistory.html)]

---
# Por que desistir do .RData e .Rhistory 

- Se todos os resultados parciais de uma an√°lise estiverem dispon√≠veis a qualquer momento, **diminui o incentivo para a escrita de c√≥digo reprodut√≠vel**

- Se todo o hist√≥rico de comandos for acess√≠vel, acaba a necessidade de experimentos controlados

- Ao dependermos ativamente do `.Rdata`, **se acidentalmente sobrescrevemos um objeto** relevante e o c√≥digo para recri√°-lo n√£o estiver mais acess√≠vel, **n√£o haver√° nenhuma forma confi√°vel de recuper√°-lo**

- A menos que pretendamos sentar com colegas para explicar como utilizar os objetos do `.RData` e do `.Rhistory`, **n√£o pode-se esperar que outra pessoa seja capaz de reproduzir uma an√°lise**

- O R trata todos os objetos guardados na mem√≥ria igualmente. Isso significa que ele tamb√©m ir√° armazenar nos arquivos ocultos todas as bases de dados da sess√£o. Assim, o `.RData` **pode ser um arquivo de m√∫ltiplos gigabytes**

---
class: middle, center, inverse
# Fundamentos de desenvolvimento de pacotes em R

---
# Pacotes

Um pacote do R √© uma forma espec√≠fica de organizar seus c√≥digo, seguindo o protocolo descrito pela R Foundation:

&gt; _Pacotes s√£o a unidade fundamental de c√≥digo R reprodut√≠vel._
&gt; 
&gt; ‚Äî Wickham &amp; Bryan

.pull-left[
- Pacotes incluem: 
  
  - Fun√ß√µes em R
  
  - Documenta√ß√£o sobre como us√°-las
  
  - Testes
  
  - Dados de exemplo
]

.pull-right[
&lt;img src="img/pacote.gif" style="display: block; margin: auto;" /&gt;
]

---
# Motiva√ß√£o

Por que aprender a fazer um pacote se scripts funcionam bem o suficiente? Por que divulgar meus pacotes em algum servi√ßo open source?

- Compartilhar c√≥digo √© sempre uma boa ideia para que a comunidade se beneficie dos avan√ßos individuais de quem a comp√µe

- Para programar melhor, precisamos receber ajuda e sugest√µes de outras pessoas mais experientes

- √â muito mais f√°cil usar controle de vers√£o e integra√ß√£o cont√≠nua se voc√™ estiver programando um pacote

- Reprodutibilidade

- Reprodutibilidade

- Reprodutibilidade

---
# Vantagens

- Padroniza a organiza√ß√£o dos c√≥digos

- Integra√ß√£o com pacotes que aceleram desenvolvimento

- Motiva e facilita a documenta√ß√£o do c√≥digo

- Facilita o compartilhamento e a reutiliza√ß√£o de c√≥digos em outros projetos e com outras pessoas

&gt; _Qualquer coisa que possa ser automatizada, deve ser automatizada._
&gt; 
&gt; ‚Äî Wickham &amp; Bryan

.footnote[Fonte: [R Packages](https://r-pkgs.org/intro.html)]

---
# Simplificando tudo: usethis

O pacote `{usethis}` ajuda com todo o fluxo de desenvolvimento em R. Ele ajuda a criar arquivos, projetos, usar o Git, criar reposit√≥rios no GitHub e muito mais.

Apresentaremos v√°rias fun√ß√µes do `{usethis}` ao longo do curso!

&lt;br&gt;

&lt;img src="img/usethis.png" width="15%" style="display: block; margin: auto;" /&gt;

---
class: middle, center

# Resumo do pacote usethis

&lt;img src="https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/rstats-artwork/usethis.png" width="70%" style="display: block; margin: auto;" /&gt;


---
# Nomes

Suponha que voc√™ criou uma fun√ß√£o incr√≠vel que voc√™ quer compartilhar com o mundo. Ela tem v√°rias fun√ß√µes auxiliares e um comportamento complexo o suficiente para depender de uma documenta√ß√£o... Voc√™ precisa criar um pacote.

Mas qual deve ser o seu nome?

&gt; _H√° apenas duas coisas dif√≠ceis na Ci√™ncia da Computa√ß√£o: invalida√ß√£o de cache e dar nome para as coisas._
&gt; 
&gt; ‚Äî Phil Karlton

Os melhores nomes s√£o simples e descritivos. Pense em algo que possa ser procurado facilmente no Google e que, preferencialmente, seja em ingl√™s (a menos que voc√™ n√£o ache que pessoas de outro pa√≠s usar√£o o seu pacote).

Evite usar letras mai√∫sculas ou mesmo n√∫meros pois isso pode confundir os usu√°rios. Voc√™ definitavente ganha pontos extras se conseguir inserir alguma brincadeira com a letra R no nome (`stringr`, `decryptr`, `plyr`, `purrr`, etc.).

---
# Dica para pesquisar nomes


```r
available::available("chess", browse = FALSE)
```

```
#&gt; Urban Dictionary can contain potentially offensive results,
#&gt;   should they be included? [Y]es / [N]o:
#&gt; 1: No
#&gt; ‚îÄ‚îÄ chess ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#&gt; Name valid: ‚úî
#&gt; Available on CRAN: ‚úñ 
#&gt; Available on Bioconductor: ‚úî
#&gt; Available on GitHub:  ‚úñ 
#&gt; Abbreviations: http://www.abbreviations.com/chess
#&gt; Wikipedia: https://en.wikipedia.org/wiki/chess
#&gt; Wiktionary: https://en.wiktionary.org/wiki/chess
#&gt; Sentiment:???
```

---
# Criando um pacote

Para criar um pacote, usamos a fun√ß√£o `usethis::create_package()`

- Voc√™ deve passar um caminho como `~/Documents/meupacote` e uma nova pasta chamada `meupacote` ser√° criada dentro da pasta `Documents`. Essa pasta ser√° tanto um `Rproj` quanto um pacote, ambos chamados `meupacote`

- **Dica geral:** n√£o adicione acentos, caracteres especiais e espa√ßos no nome dos caminhos, arquivos, fun√ß√µes, pacotes, etc.


```r
# Sa√≠da no pr√≥ximo slide
usethis::create_package("~/Documents/meupacote")
```

---

```
#&gt; ‚úì Creating '/home/clente/Documents/meupacote/'
#&gt; ‚úì Setting active project to '/home/clente/Documents/meupacote'
#&gt; ‚úì Creating 'R/'
#&gt; ‚úì Writing 'DESCRIPTION'
#&gt; Package: meupacote
#&gt; Title: What the Package Does (One Line, Title Case)
#&gt; Version: 0.0.0.9000
#&gt; Authors@R (parsed):
#&gt;     * First Last &lt;first.last@example.com&gt; [aut, cre] (YOUR-ORCID-ID)
#&gt; Description: What the package does (one paragraph).
#&gt; License: `use_mit_license()`, `use_gpl3_license()` or friends to
#&gt;     pick a license
#&gt; Encoding: UTF-8
#&gt; LazyData: true
#&gt; Roxygen: list(markdown = TRUE)
#&gt; RoxygenNote: 7.1.1
#&gt; ‚úì Writing 'NAMESPACE'
#&gt; ‚úì Writing 'meupacote.Rproj'
#&gt; ‚úì Adding '^meupacote\\.Rproj$' to '.Rbuildignore'
#&gt; ‚úì Adding '.Rproj.user' to '.gitignore'
#&gt; ‚úì Adding '^\\.Rproj\\.user$' to '.Rbuildignore'
#&gt; ‚úì Opening '/home/clente/Documents/meupacote/' in new RStudio session
#&gt; ‚úì Setting active project to '&lt;no active project&gt;'
```

---
# Diret√≥rio de trabalho

O arquivo `meupacote.Rproj` indica para o RStudio que aquele diret√≥rio ser√° a raiz de um projeto e que, sempre que o projeto estiver aberto, ser√° utilizado por padr√£o como o diret√≥rio de trabalho.

- *Working directory* √© a pasta em que o R vai procurar arquivos na hora de ler informa√ß√µes ou gravar arquivos na hora de salvar objetos

- Se voc√™ n√£o souber qual √© o seu diret√≥rio de trabalho, voc√™ pode descobri-lo usando a fun√ß√£o `getwd()`. Ela vai devolver uma string com o caminho do seu diret√≥rio de trabalho

Fixar o diret√≥rio de trabalho como a pasta raiz do projeto, ao lado da regra de manter todos os arquivos dentro da pasta do projeto, garante que sua an√°lise poder√° ser executada por qualquer pessoa e em qualquer computador sem a preocupa√ß√£o de ajustar caminhos at√© os arquivos utilizados ou criados pelo seu c√≥digo.

---
# Estrutura b√°sica do pacote

Essa √© a estrutura criada quando usamos a fun√ß√£o `usethis::create_package()`:

- `meupacote.Rproj`: este arquivo faz com que este diret√≥rio seja um projeto no RStudio (RStudio Project)

- `LICENSE`: especifica os termos de uso e distribui√ß√£o do seu pacote

- `DESCRIPTION`: define o nome, descri√ß√£o, vers√£o, licen√ßa, depend√™ncias e outras caracater√≠sticas do seu pacote

- `R/`: aqui ficam as fun√ß√µes desenvolvidas em R

- `.Rbuildignore`:  Lista arquivos que n√£o devem ser inclu√≠dos ao compilar o pacote R a partir do c√≥digo-fonte
&lt;!-- usethis::use_build_ignore("..") ajuda a adicionar arquivos no .Rbuildignore--&gt;

- `NAMESPACE`: N√£o devemos editar este arquivo manualmente. Ele declara as fun√ß√µes que o pacote exporta para uso externo e as fun√ß√µes externas que seu pacote importa de outros pacotes

---
# Sobre licen√ßas de c√≥digo aberto

- O pacote `{usethis}` possui algumas func√µes para nos ajudar a declarar uma licen√ßas como, por exemplo:


```r
usethis::use_cc0_license()
```

- CC0: essa licen√ßa, muitas vezes chamada de "sem direitos reservados", permite que o trabalho seja colocado em dom√≠nio p√∫blico. Qualquer pessoa pode usar, modificar, distribuir e vender o seu trabalho sem nenhuma restri√ß√£o de direitos autorais


```r
usethis::use_mit_license()
```

- MIT: curta e permissiva, a licen√ßa MIT exige apenas manuten√ß√£o dos direitos autorais. Modifica√ß√µes e trabalhos maiores podem ser distribu√≠dos sob outros termos de uso


```r
usethis::use_gpl3_license()
```

- GPLv3: essa licen√ßa exige que o c√≥digo-fonte dos derivados seja _open source_ sob a mesma licen√ßa. Direitos autorais devem ser preservados.

---

# Testando o pacote na pr√°tica

Podemos usar a fun√ß√£o `devtools::check()`. Ela carrega todo o c√≥digo, gera toda a documenta√ß√£o e executa todos os testes, verificando em todo passo se tudo est√° funcionando como o esperado.

1. Crie o pacote usando a fun√ß√£o `usethis::create_package("caminho_onde_o_pacote_sera_criado/nomedopacote")` 

1. Observe a estrutura do diret√≥rio

1. Carregue o pacote com `devtools::load_all()` (**CTRL + SHIFT + L**)

1. Cheque se est√° tudo OK com o seu pacote com `devtools::check()`

1. Adicione uma licen√ßa no pacote (com `usethis::use_***_license()`) para corrigir o alerta

1. Adicione suas informa√ß√µes no `DESCRIPTION`: nome, descri√ß√£o do pacote, etc.

---
# A pasta R/

Dentro de um pacote, a pasta `R/` s√≥ pode ter arquivos R com fun√ß√µes.

- Uma fun√ß√£o √© respons√°vel por executar uma tarefa pequena, mas muito bem. Quando trabalhamos com fun√ß√µes, nossas opera√ß√µes ficam mais confi√°veis.

- A ideia da pasta `R/` √© guardar em um local comum tudo aquilo que n√≥s utilizamos como ferramenta interna para nossas an√°lises, bem como aquilo que queremos que outras pessoas possam usar no futuro.

- Podemos usar `usethis::use_r("nome-do-arquivo")` para que um arquivo seja criado antes come√ßarmos a escrever uma fun√ß√£o.

- Assim que escrevermos/modificarmos alguma fun√ß√£o, podemos carreg√°-las e test√°-las manualmente com `devtools::load_all()`

---
# Vantagens de usar fun√ß√µes

- Um c√≥digo bem encapsulado reduz a necessidade de objetos intermedi√°rios (`base_tratada`, `base_filtrada` etc.) pois para gerar um deles basta a aplica√ß√£o de uma fun√ß√£o.

- Programas com fun√ß√µes normalmente s√£o muito mais enxutos e limpos do que *scripts* soltos, pois estes estimulam repeti√ß√£o de c√≥digo.

- Ao encontrar um bug, haver√° apenas um lugar para concertar; se surgir a necessidade de modificar uma propriedade, haver√° apenas um lugar para editar; se aquele c√≥digo se tornar obsoleto, haver√° apenas um lugar para deletar.

.footnote[Leia mais [neste cap√≠tulo do livro R for Data Science](https://r4ds.had.co.nz/functions.html)]

---
# Criando a sua pr√≥pria fun√ß√£o

Quando estamos desenvolvendo pacotes, iremos criar fun√ß√µes para executar as tarefas necess√°rias:


```r
nome_da_funcao &lt;- function(argumento_1, argumento_2 = valor_padrao_2) {
  # C√≥digo que a fun√ß√£o ir√° executar
}
```

Um exemplo: vamos criar uma fun√ß√£o que soma dois n√∫meros.


```r
minha_soma &lt;- function(x, y) { # minha_soma √© uma fun√ß√£o de x e y
  soma &lt;- x + y # soma √© igual a x + y
  soma # resultado retornado
}

minha_soma(2, 2)
```

```
#&gt; [1] 4
```

Se quisermos dar valores padr√µes para os argumentos, basta colocar um `=` na defini√ß√£o da fun√ß√£o.

---
# Depend√™ncias

Sem os in√∫meros pacotes criados pela comunidade, o R provavelmente j√° estaria no por√£o da Ci√™ncia de Dados. Por isso, √© a primeira coisa que escrevemos nos nossos *scripts* quase sempre √© `library(algumPacoteLegal)`.

Quando lidamos com pacotes, a fun√ß√£o `library()` n√£o pode ser utilizada, e todas as fun√ß√µes devem ter seus pacotes de origem explicitamente referenciados pelo operador `::`.

- O c√≥digo, no total, executa um pouco mais r√°pido porque s√£o carregadas menos fun√ß√µes no ambiente global (isso √© especialmente importante em aplica√ß√µes interativas feitas em Shiny).

- As depend√™ncias do c√≥digo est√£o sempre atualizadas porque elas est√£o diretamente atreladas √†s pr√≥prias fun√ß√µes sendo utilizadas.

  - `usethis::use_package()`: adiciona pacotes que foram instalados via CRAN
  
  - `usethis::use_dev_package()`: adiciona pacotes que n√£o foram instalados via CRAN

- Para escrever `dplyr::`, por exemplo, basta digitar `d`, `p`, `l` e apertar TAB uma vez. Com os `::`, as sugest√µes passar√£o a ser somente de fun√ß√µes daquele pacote.

---
# Discuss√£o em sala

- Como podemos transformar o c√≥digo a seguir em uma fun√ß√£o que far√° parte de um pacote?

- Exemplo: Importar a base mananciais e calcular a m√©dia do volume de √°gua armazenado (em %) para o sistema Cantareira, em abril de 2021.


```r
library(tidyverse)
library(lubridate)

"https://git.io/JOLeb" %&gt;%
  read_csv2() %&gt;%
  mutate(ano = year(data), mes = month(data)) %&gt;%
  group_by(sistema, ano, mes) %&gt;%
  summarise(media_volume_porcentagem = mean(volume_porcentagem)) %&gt;%
  filter(ano == 2021, mes == 4, sistema == "Cantareira")
```

.footnote[Fonte: [pacote](https://github.com/beatrizmilz/mananciais/raw/master/inst/extdata/mananciais.csv) `{mananciais}` por Beatriz Milz]

---
# Discuss√£o em sala

C√≥digo original:


```r
library(tidyverse)
library(lubridate)

"https://git.io/JOLeb" %&gt;%
  read_csv2() %&gt;%
  mutate(ano = year(data), mes = month(data)) %&gt;%
  group_by(sistema, ano, mes) %&gt;%
  summarise(media_volume_porcentagem = mean(volume_porcentagem)) %&gt;%
  ungroup() %&gt;%
  filter(ano == 2021, mes == 4, sistema == "Cantareira")
```

---
# Discuss√£o em sala

Passo 1: Adicionar os quatro pontos `::`


```r
library(tidyverse)
library(lubridate)

"https://git.io/JOLeb" %&gt;%
  readr::read_csv2() %&gt;%
  dplyr::mutate(ano = lubridate::year(data), mes = lubridate::month(data)) %&gt;%
  dplyr::group_by(sistema, ano, mes) %&gt;%
  dplyr::summarise(media_volume_porcentagem = mean(volume_porcentagem)) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::filter(ano == 2021, mes == 4, sistema == "Cantareira")
```

---
# Discuss√£o em sala

Passo 2: Declarar as depend√™ncias com a fun√ß√£o `usethis::use_package()`. N√£o precisaremos mais do `library()`!

Vamos **remover** isso do c√≥digo da fun√ß√£o...


```r
library(tidyverse)
library(lubridate)
```

E declararemos as depend√™ncias... faremos isso no console, e n√£o no c√≥digo da fun√ß√£o!


```r
usethis::use_package("lubridate")
usethis::use_package("readr")
usethis::use_package("dplyr")

# Tamb√©m usamos o pipe!
usethis::use_pipe()
```

---
# Discuss√£o em sala

Passo 3: Adicionar o c√≥digo dentro de uma fun√ß√£o. Chamaremos de `calcular_media_volume()`.


```r
calcular_media_volume &lt;- function() {
  "https://git.io/JOLeb" %&gt;%
    readr::read_csv2() %&gt;%
    dplyr::mutate(ano = lubridate::year(data), mes = lubridate::month(data)) %&gt;%
    dplyr::group_by(sistema, ano, mes) %&gt;%
    dplyr::summarise(media_volume_porcentagem = base::mean(volume_porcentagem)) %&gt;%
    dplyr::ungroup() %&gt;%
    dplyr::filter(ano == 2021, mes == 4, sistema == "Cantareira")
}
```

---
# Discuss√£o em sala

Passo 4: pensar em quais podem ser os argumentos da nossa fun√ß√£o. E se eu quiser calcular a m√©dia em outro m√™s? Outro ano? Outro sistema?


```r
calcular_media_volume &lt;- function(filtro_sistema, filtro_ano, filtro_mes) {
  "https://git.io/JOLeb" %&gt;%
    readr::read_csv2() %&gt;%
    dplyr::mutate(ano = lubridate::year(data), mes = lubridate::month(data)) %&gt;%
    dplyr::group_by(sistema, ano, mes) %&gt;%
    dplyr::summarise(media_volume_porcentagem = base::mean(volume_porcentagem)) %&gt;%
    dplyr::ungroup() %&gt;%
    dplyr::filter(ano == filtro_ano, mes == filtro_mes, sistema == filtro_sistema)
}
```


```r
calcular_media_volume(filtro_sistema = "Guarapiranga",
                      filtro_ano = 2021, filtro_mes = 3)
```

```
#&gt; # A tibble: 1 x 4
#&gt;   sistema        ano   mes media_volume_porcentagem
#&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;                    &lt;dbl&gt;
#&gt; 1 Guarapiranga  2021     3                     73.9
```

---
# Discuss√£o em sala

Passo 5: argumentos padr√£o. E se eu quiser que a fun√ß√£o funcione caso o ano e/ou o m√™s n√£o seja informado como argumento? 


```r
calcular_media_volume &lt;- function(filtro_sistema,
                                  filtro_ano = 2021,
                                  filtro_mes = 4) {
  "https://git.io/JOLeb" %&gt;%
    readr::read_csv2() %&gt;%
    dplyr::mutate(ano = lubridate::year(data), mes = lubridate::month(data)) %&gt;%
    dplyr::group_by(sistema, ano, mes) %&gt;%
    dplyr::summarise(media_volume_porcentagem = base::mean(volume_porcentagem)) %&gt;%
    dplyr::ungroup() %&gt;%
    dplyr::filter(ano %in% filtro_ano,
                  mes %in% filtro_mes,
                  sistema %in% filtro_sistema)
}
```

---
# Discuss√£o em sala


```r
calcular_media_volume(filtro_sistema = "Guarapiranga")
```

```
#&gt; # A tibble: 1 x 4
#&gt;   sistema        ano   mes media_volume_porcentagem
#&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;                    &lt;dbl&gt;
#&gt; 1 Guarapiranga  2021     4                     70.1
```

---
# Recomenda√ß√µes

Algumas recomenda√ß√£o sobre como organizar seu c√≥digo:

- Evite usar `.` no nome das suas fun√ß√µes (hoje em dia usar `_` √© muito mais comum)

- Use nomes descritivos para as fun√ß√µes, pois isso facilita a manuten√ß√£o e o uso do pacote

- Tente se limitar a 80 caracteres por linha porque isso permite que seu c√≥digo caiba confortavelmente em qualquer tela

- N√£o use `library()` ou `require()`, pois isso vai causar problemas (use a nota√ß√£o `pacote::fun√ß√£o()`)

- **Nunca** use `source()`, todo o c√≥digo j√° ser√° carregado automaticamente com `devtools::load_all()`

- N√£o usar "metapackages" (como o tidyverse)

---
# Criando uma fun√ß√£o na pr√°tica

- Crie um arquivo onde iremos escrever a fun√ß√£o para o pacote. Dica: use a fun√ß√£o `usethis::use_r("nome-do-arquivo")`!

- Copie o c√≥digo dispon√≠vel em [git.io/JO8NV](https://git.io/JO8NV) e cole no arquivo criado.

- Adapte o c√≥digo e o transforme em uma fun√ß√£o. N√£o esque√ßa das depend√™ncias

- Verifique que o arquivo onde sua fun√ß√£o foi escrita est√° no diret√≥rio `R/` e que as depend√™ncias est√£o descritas no arquivo `DESCRIPTION`

- Carregue o pacote com `devtools::load_all()`, e confira se est√° tudo ok com `devtools::check()`!

### Exerc√≠cios para casa

- [Exerc√≠cio: git.io/JO8Nr](https://git.io/JO8Nr)

- [Desafio: git.io/JO8NP](https://git.io/JO8NP)



.footnote[Fonte: dados do [pacote brasileir√£o](https://blog.curso-r.com/posts/2021-03-02-brasileirao/)]

---
# Dados

Se voc√™ quiser inserir dados ao seu pacote, voc√™ pode utilizar a fun√ß√£o `usethis::use_data()`. 

Ela criar√° uma pasta `data/` na raiz do seu pacote, caso ela n√£o exista ainda, e salvar√° nela o objeto `meus_dados` em formato `.rda`.

Arquivos `.rda` s√£o extremamente est√°veis, compactos e podem ser carregados rapidamente pelo R, tornando este formato o principal meio de guardar dados de um pacote.

---
# Breve retorno

Passo 6: adicionando bases de dados ao pacote. Ao executar o comando abaixo no Console, a base √© salva como um `.rda` e podemos invocar o objeto diretamente na nossa fun√ß√£o.


```r
partidas_brasileirao &lt;- readr::read_csv2("https://git.io/JOqUN")
usethis::use_data(partidas_brasileirao)
```

```
‚úì Setting active project to '/home/clente/Documents/meupacote'
‚úì Adding 'R' to Depends field in DESCRIPTION
‚úì Saving 'partidas_brasileirao' to 'data/partidas_brasileirao.rda'
‚óè Document your data (see 'https://r-pkgs.org/data.html')
```


```r
encontrar_pior_ano_time &lt;- function(time) {
  partidas_brasileirao %&gt;%
    dplyr::group_by(temporada, quem_ganhou) %&gt;%
    dplyr::filter(quem_ganhou != "Empate", quem_ganhou %in% time) %&gt;%
    dplyr::count(quem_ganhou, sort = TRUE, name = "n_vitorias") %&gt;%
    dplyr::ungroup() %&gt;%
    dplyr::filter(n_vitorias == min(n_vitorias)) %&gt;%
    dplyr::rename("time" = quem_ganhou)
}
```

---
# Manipulando dados crus

Se a base que voc√™ quiser colocar no pacote for o resultado de um processo de manipula√ß√£o de uma base crua, voc√™ pode salvar a base crua e o c√≥digo desse processo na pasta `data-raw`. 

Para isso, utilize a fun√ß√£o `usethis::use_data_raw("meus_dados")`. Ela criar√° uma pasta `data-raw/` na raiz do seu pacote, caso ela n√£o exista ainda, e um arquivo `meus_dados.R` onde voc√™ colocar√° o c√≥digo de manipula√ß√£o da base crua.

---
# Qual a diferen√ßa entre R/ e data-raw/?

`data-raw`

- A pasta `data-raw/` √© sua caixa de areia

- Apesar de existirem formas razo√°veis de organizar seus pacotes aqui, nessa parte voc√™ ser√° livre

`R/`

- J√° a pasta `R/` conter√° fun√ß√µes bem organizadas e documentadas

- Por exemplo, uma fun√ß√£o que ajusta um modelo estat√≠stico, outra que arruma um texto de um jeito patronizado, ou uma que cont√©m seu tema customizado do `{ggplot2}`

- Dentro dessa pasta voc√™ n√£o deve carregar outros pacotes com `library()`, mas sim usar o operador `::`

---
class: middle, center, inverse
# Documenta√ß√£o

---
# Documenta√ß√£o de fun√ß√µes

Se quisermos adicionar documenta√ß√£o ao nosso pacote (as instru√ß√µes que aparecem quando vamos usar uma fun√ß√£o ou o documento mostrado quando rodamos `?fun√ß√£o()`) precisamos usar um coment√°rio especial: `#'`


```r
#' T√≠tulo da fun√ß√£o
#'
#' Descri√ß√£o da fun√ß√£o
#'
#' @param a primeiro par√¢metro
#' @param b segundo par√¢metro
#'
#' @return descri√ß√£o do resultado
#'
#' @export
fun &lt;- function(a, b) {
  a + b
}
```

---
# Documenta√ß√£o de fun√ß√µes

- O par√¢metro `@export` indica que a fun√ß√£o ficar√° dispon√≠vel quando rodarmos `library(meupacote)`. N√£o se esque√ßa de exportar todas (e somente) as fun√ß√µes p√∫blicas!

- O RStudio disponibiliza um atalho para criar a estrutura da documenta√ß√£o de uma fun√ß√£o. No menu superior, clique em `Code` -&gt;  `Insert Roxygen Skeleton`.

- Para deixar a documenta√ß√£o das suas fun√ß√µes acess√≠vel (no help do R), use a fun√ß√£o `devtools::document()` (**CTRL + SHIFT + D**).

- Ao executar `devtools::check()`, a documenta√ß√£o j√° √© atualizada e disponibilizada de brinde

---
# Documenta√ß√£o de bases de dados


```r
#' T√≠tulo da base
#'
#' Descri√ß√£o da base
#'
#' @format Uma lista que descreve as colunas:
#' \describe{
#'   \item{col1}{Descri√ß√£o da coluna 1}
#'   \item{col2}{Descri√ß√£o da coluna 2}
#'   ...
#' }
#' @source Origem dos dados
"base"
```

- `@format` descreve o formato da base (n√∫mero de colunas, linhas, etc.) e pode conter uma lista que explica o significado de cada coluna

- `@source` √© a fonte, muitas vezes um `\url{}`

- **Nunca** coloque `@export` em uma base de dados

---
# Acentos, encoding e vari√°veis globais

Prefira manter os arquivos em ingl√™s para que seu pacote possa ser submetido ao CRAN.

- Se quiser fazer um pacote com documenta√ß√£o em portugu√™s, tente escrever sem acentos ou escapar strings (veja `abjutils::escape_unicode()`). O `devtools::check()` vai te alertar caso essa regra seja violada

O _encoding_ (codifica√ß√£o) dos arquivos deve ser **sempre** UTF-8 para evitar problemas entre plataformas.

- Se tiver problemas com isso, tente **File &gt; Reopen with Encoding...**, ou **File &gt; Save with Encoding...**, ou **Tools &gt; Project Options... &gt; Code Editing &gt; Text encoding**

Vari√°veis globais s√£o normalmente uma m√° pr√°tica em c√≥digo R, ent√£o a `devtools::check()` vai reclamar se encontrar algo do tipo; o problema √© que as colunas modificadas em fun√ß√µes do `{dplyr}` s√£o caracterizadas como globais.

- A solu√ß√£o √© criar um arquivo com uma linha como a abaixo contendo todas as vari√°veis que fizerem a `devtools::check()`reclamar


```r
utils::globalVariables(c("variavel1", "variavel2"))
```

---
# Boas pr√°ticas no desenvolvimento

- N√£o rode as fun√ß√µes diretamente. Utilize sempre a fun√ß√£o `devtools::load_all()`. Ela carrega todas as fun√ß√µes da pasta `R/` e as bases salvas na pasta `data/`. Isso diminuir√° a chance de elas estarem sendo afetadas por valores externos que est√£o no seu *Environment*.

- Limpe o seu *Environment* sempre que poss√≠vel. Um atalho √∫til: **CTRL + SHIFT + F10**.

- Para deixar a documenta√ß√£o das suas fun√ß√µes acess√≠vel (no help do R), use a fun√ß√£o `devtools::document()`.

- Se voc√™ precisar instalar o seu pacote (equivalente ao que fazemos com pacotes do CRAN quando rodamos `install.packages()`), use a fun√ß√£o `devtools::install()`. Ela deve ser utilizada quando o seu pacote estiver pronto (ou pelo menos alguma vers√£o dele).

&lt;!-- Acho que tem mais coisa aqui, mas isso tudo j√° √© bem bom --&gt;

---

# Documenta√ß√£o na pr√°tica

Passo 7: Pratique o que aprendemos sobre documenta√ß√£o de pacotes!

1. Execute e observe o resultado de `devtools::check()`. L√° ter√£o indica√ß√µes do que devemos fazer

1. Crie uma lista de vari√°veis globais e adicione os elementos que aparecem no check em _Undefined global functions or variables_

1. Documente a base de dados

1. Documente as fun√ß√µes do pacote

1. Execute e observe novamente o resultado de `devtools::check()`. O objetivo √© obter:

.center[`0 errors ‚úì | 0 warnings ‚úì | 0 notes ‚úì`]

---
class: middle, center, inverse
name: testes-unitarios

# Testes unit√°rios e consist√™ncia de c√≥digo


.footnote[Leia mais [neste cap√≠tulo do livro Zen do R](https://curso-r.github.io/zen-do-r/testes.html).]

---

# Testes

Se quisermos verificar que todo o pacote continua funcionando mesmo depois fazer alguma altera√ß√£o, precisamos de testes automatizados.

Para isso, basta rodar `usethis::use_testthat()` (apenas uma vez por pacote) e depois `usethis::use_test("nome_do_teste")` (para cada novo arquivo de testes que quiser criar).

Com o pacote testthat podemos criar quantos arquivos de testes quisermos, cada um com um n√∫mero ilimitado de testes e sub-testes. Quando tivermos todos os testes prontos, basta rodar `devtools::test()`. Atalho: **Ctrl + Shift + T**.

---

# Exemplo de teste

Considerando a fun√ß√£o:
```r
tira_media &lt;- function(x, rm_na = TRUE) {
  purrr::reduce(x, sum, na.rm = rm_na)/conta_itens(x, rm_na)
}
```

Podemos escrever os seguintes testes:
```r
test_that("taking the mean works", {
            expect_equal(tira_media(c(1, 2, 3, 4, NA, 6)), 3.2)
            expect_equal(tira_media(c(1, 2, 3, 4, 6)), 3.2)
          })
test_that("rm_na works as expected", {
            expect_output(tira_media(c(1, 2, NA), rm_na = FALSE), NA)
            expect_equal(tira_media(c(NA, NA, NA)), NaN)
          })
```

---
# Testes na pr√°tica

Passo 8: Pratique o que aprendemos sobre testes!

1. Use a fun√ß√£o `usethis::use_testthat()` para preparar o pacote 

1. Abra o arquivo da fun√ß√£o que deseja escrever testes, e use a fun√ß√£o  `usethis::use_test()` para criar o arquivo onde o teste ser√° escrito

1. Desenvolva um teste para a fun√ß√£o

1. Execute e observe novamente o resultado de `devtools::check()`. O objetivo √© obter:

.center[`0 errors ‚úì | 0 warnings ‚úì | 0 notes ‚úì`]

---
class: middle, center, inverse
# Git e GitHub

---
# Git

- Git √© um **sistema de versionamento**, criado por Linus Torvalds, autor do Linux.

- √â capaz de guardar o hist√≥rico de altera√ß√µes de todos os arquivos dentro de uma pasta, que chamamos de reposit√≥rio.

- Funciona como o "*Track changes*" do word, mas muito melhor.

- Torna-se importante √† medida que seu trabalho √© __colaborativo__.

- Git √© um software que voc√™ instala no computador.

- Arquivo `.gitignore`: Lista arquivos que dever√£o ser ignorados ao versionar o pacote com Git. 

&lt;br&gt;

&lt;img src="img/git.png" width="30%" style="display: block; margin: auto;" /&gt;

---
# GitHub

- GitHub √© um site onde voc√™ coloca e compartilha reposit√≥rios Git.

- Utilizado por milh√µes de pessoas em projetos de c√≥digo aberto ou fechado.

- √ötil para colaborar com outros programadores em projetos de ci√™ncia de dados.

- Existem alternativas, como [GitLab](https://about.gitlab.com/) e [BitBucket](https://bitbucket.org/product).

- GitHub √© um site que voc√™ acessa na internet.

&lt;br&gt;

&lt;img src="img/github.png" width="40%" style="display: block; margin: auto;" /&gt;

---
# Pacotes e GitHub



.pull-left[


Pacotes do R e reposit√≥rios do GitHub s√£o melhores amigos.



&lt;br&gt;

O grande cupido dessa amizade √© o `{usethis}`.
]

.pull-right[

&lt;img src="img/hug.gif" width="90%" style="display: block; margin: auto;" /&gt;

]


---
# Fluxo de trabalho

O diagrama abaixo exemplifica o fluxo de trabalho de um projeto com versionamento.


&lt;img src="img/fluxo_github_rstudio.png" width="70%" style="display: block; margin: auto;" /&gt;

---

# Configure seu usu√°rio do Git

Antes de come√ßarmos a versionar o c√≥digo do nosso pacote, vamos configurar o Git e o GitHub no RStudio. 

Esse processo precisa ser feito apenas uma vez!


```r
usethis::use_git_config(
  user.name = "SEU NOME NO GITHUB",
  user.email = "seu_email_no@github.com"
)
```

- Em `user.name`, pode ser seu nome mesmo, n√£o precisa ser o nickname.

- O `user.email` precisa ser o que est√° vinculado √† sua conta do GitHub.

---

# Configure o Personal Access Token

- Ao conectar com o GitHub, voc√™ ser√° instru√≠da(o) a criar um *Personal Access Token* (PAT).

- O PAT serve para autenticar ao GitHub, podendo ser utilizado como senha de acesso ou internamente para automatizar tarefas (como criar um reposit√≥rio).

- Para criar um novo PAT, use a fun√ß√£o `usethis::create_github_token()`. Uma janela do navegador ser√° aberta, e voc√™ deve autenticar no GitHub (se necess√°rio), criar o novo token, e copi√°-lo. 

- Use a fun√ß√£o `usethis::edit_r_environ()` para abrir o arquivo `.Renviron` para salvar seu token. Use essa estrutura, substituindo os 0 pelo c√≥digo copiado na etapa anterior:

```
GITHUB_PAT="0000000000000000000000000000000000000000"
```

- Lembre-se de reiniciar sua sess√£o do R!

---

# Checando se a configura√ß√£o deu certo

Utilize a fun√ß√£o `usethis::git_sitrep()` e leia o resultado que aparece no console. A mensagem abaixo foi cortada para mostrar os trechos de interesse!



```r
usethis::git_sitrep()
#&gt; Git config (global)
#&gt; ‚óè Name: 'SEU NOME DEVE APARECER AQUI'
#&gt; ‚óè Email: 'SEU EMAIL DEVE APARECER AQUI'

#&gt; GitHub
#&gt; ‚óè Default GitHub host: 'https://github.com'
#&gt; ‚óè Personal access token for 'https://github.com': '&lt;discovered&gt;'
#&gt; ‚óè GitHub user: 'SEU NOME DE USU√ÅRIO(A) DEVE APARECER AQUI'
#&gt; ‚óè Token scopes: 'gist, repo, user, workflow'
#&gt; ‚óè Email(s): 'SEU EMAIL DEVE APARECER AQUI'
```


---
# Versione com o Git e o GitHub


```r
usethis::use_git()
```

- Rodando o comando acima na pasta do projeto (a nova aba do RStudio que
apareceu) voc√™ adiciona controle de vers√£o.

- Voc√™ receber√° algumas instru√ß√µes para seguir, mas est√° tudo certo.


```r
usethis::use_github()
```

- O comando acima sincroniza a pasta com o GitHub.

- Mais uma vez, voc√™ receber√° algumas instru√ß√µes, mas lembre-se apenas de selecionar o m√©todo de autentica√ß√£o `https`.

---
# Stage &amp; Commit

&lt;img src="img/passo_3_commit_1.gif" width="50%" style="display: block; margin: auto;" /&gt;

- Nesta etapa, voc√™ estar√° descrevendo as modifica√ß√µes que fez nos arquivos selecionados.

- __Observa√ß√£o__: o ato de clicar no item √© o passo de Stage.

---

# Push

&lt;img src="img/passo_4_push.gif" width="50%" style="display: block; margin: auto;" /&gt;

- *Push* (ou *dar push*) significa atualizar o seu reposit√≥rio remoto (GitHub) com os arquivos que voc√™ *commitou* no passo anterior.

---

# Extra: Pull

&lt;img src="img/passo_5_pull.gif" width="50%" style="display: block; margin: auto;" /&gt;

- *Pull* √© a a√ß√£o inversa do *Push*: voc√™ trar√° a vers√£o mais recente dos arquivos do seu reposit√≥rio remoto (GitHub) para a sua m√°quina (caso voc√™ tenha subido uma vers√£o de um outro computador ou uma outra pessoa tenha subido uma atualiza√ß√£o).

---

# Resumo

1. Reposit√≥rio: Criar projeto/pacote

2. Adicionar Git

3. Adicionar GitHub

4. Commit: Edite e "Commite" as mudan√ßas no c√≥digo

5. Push: Suba os commits para o GitHub

6. Pull (extra): Baixe o estado atual do projeto

### Cuidados

- Se uma base de dados tem mais do que 50Mb de tamanho, ela n√£o deveria estar no seu reposit√≥rio.

- Nem sempre o comando Pull d√° certo. √Äs vezes, voc√™ e a colega de trabalho fizeram mudan√ßas no mesmo arquivo e, quando v√£o juntar, ocorre um conflito.

---
# Comunica√ß√£o


### Vignettes

√â muito comum a constru√ß√£o de *vignettes* para documentar o pacote. Elas s√£o documentos em HTML melhor formatados do que a tradicional documenta√ß√£o do R.

Voc√™ pode usar a fun√ß√£o `usethis::use_vignette()` para criar *vignettes*.

### Outros

Se voc√™ precisar construir sites, relat√≥rios, dashboards est√°ticos (flexdashboard) dentro do seu pacote, voc√™ pode criar uma pasta chamada `docs/` na raiz do seu projeto para guardar esses arquivos.

Veremos tamb√©m como criar um site do pacote criado com o `{pkgdown}`.

---

.pull-left[
# O arquivo README.md 

O arquivo `README.md` √© importante pois cont√©m informa√ß√µes como: logo (opcional!), introdu√ß√£o (o que ele faz?), instru√ß√µes de instala√ß√£o, exemplos de uso, etc.
  
  
A fun√ß√£o `usethis::use_readme_rmd()` cria um arquivo `README.Rmd`. Esse arquivo j√° possui uma estrutura para facilitar o preenchimento das informa√ß√µes. 


O arquivo gerado √© um **RMarkdown** (`.Rmd`), e portanto precisamos converter para **Markdown** (`.md`). Para isso podemos usar a fun√ß√£o `usethis::build_readme()`.

&lt;!-- Citamos aqui o bot√£o knit? --&gt;
]

.pull-right[
&lt;img src="img/readme-chess.png" width="90%" style="display: block; margin: auto;" /&gt;

.footnote[Fonte da imagem: [README do pacote {chess}](https://github.com/curso-r/chess)]

]






---

# Criando um site para o pacote com {pkgdown}

.pull-left[


O pacote pkgdown permite criar um site para o pacote. Para criar, use a fun√ß√£o a seguir uma vez, para configurar o pacote para usar o pkgdown:

```r
usethis::use_pkgdown()
```
]

.pull-right[
&lt;img src="img/pkgdownchess.png" width="90%" style="display: block; margin: auto;" /&gt;

.footnote[Fonte da imagem: [Site do pacote {chess}](https://github.com/curso-r/chess)]

]

---

# Criando um site para o pacote com {pkgdown} (cont.)

Conte√∫do do site ser√° gerado a partir dos documentos j√° existentes no pacote: 

- O conte√∫do do site estar√° no diret√≥rio `docs/`. 

- O arquivo `README.md` ser√° usado para criar a p√°gina principal do site;

- A documenta√ß√£o das fun√ß√µes ser√£o usadas para criar a se√ß√£o 'references'

- As vignettes ser√£o usadas para criar a se√ß√£o 'articles'

O site n√£o √© atualizado automaticamente. Caso mude algo nos itens descritos acima, voc√™ deve atualizar o site usando a fun√ß√£o:

```r
pkgdown::build_site()
```

---

# Criando um site para o pacote com {pkgdown} (cont.)

- Os passos anteriores geram o conte√∫do do site no diret√≥rio `docs/`, mas para que o site do pacote fique dispon√≠vel na internet para que outras pessoas consultem √© necess√°rio:

  - O pacote estar vinculado a um reposit√≥rio no GitHub (falamos disso na se√ß√£o passada)

  - No reposit√≥rio do pacote, clique em **Settings**, e no menu lateral escolha **Pages**
    
  - Em **Source**, selecione a sua branch principal (provavelmente chama de **main** ou **master**), escolha o diret√≥rio `docs/` e clique em **save**
    
&lt;img src="img/githubpages.png" width="50%" style="display: block; margin: auto;" /&gt;
  
- O endere√ßo do site ser√° `https://seu-username.github.io/nome-repositorio/`  

---
# Integra√ß√£o cont√≠nua com GitHub Actions

&gt; GitHub Actions ajuda voc√™ a **automatizar tarefas** dentro de seu ciclo de vida de desenvolvimento de software. ([fonte](https://docs.github.com/pt/actions/learn-github-actions/introduction-to-github-actions))


.pull-left[


Alguns exemplos: 

- V√°rios pacotes usam para fazer executar o check e testes: [{readr}](https://github.com/tidyverse/readr/tree/master/.github/workflows), [{dplyr}](https://github.com/tidyverse/dplyr/tree/master/.github/workflows), [{usethis}](https://github.com/r-lib/usethis/tree/master/.github/workflows), e muitos outros

- Pacote [{brasileirao}](https://github.com/williamorim/brasileirao) - atualiza diariamente a base de dados

- Pacote [{goal500}](https://github.com/jtrecenti/goal500) - atualiza a base e o README, uma vez por semana

- Pacote [{mananciais}](https://beatrizmilz.github.io/mananciais/) - atualiza diariamente a base de dados 

- P√°gina [Materiais sobre R](https://materiais-estudo-r.netlify.app/) - atualiza o site sempre que h√° mudan√ßa na base de dados



]

.pull-right[

&lt;br&gt;&lt;br&gt;

&lt;img src="https://avatars.githubusercontent.com/u/44036562?s=200&amp;v=4" style="display: block; margin: auto;" /&gt;

]

---
# Integra√ß√£o cont√≠nua com GitHub Actions

Para utilizar o GitHub Actions, usamos arquivos `.yaml` que armazenam informa√ß√µes os fluxos de trabalho.

- **Eventos**: Um evento √© uma atividade que aciona um fluxo de trabalho. Por exemplo:
  
  - Quando o reposit√≥rio recebe uma altera√ß√£o (`on: push`)
  
  - Quando um Pull Request √© criado (em outras palavras, algu√©m est√° enviando uma contribui√ß√£o para o reposit√≥rio) (`on: pull_request`)
  
  - Eventos programados. Ex: a cada hora, todos os dias, uma vez por semana, uma vez por m√™s, etc. O site [CronTab](https://crontab.guru/) √© muito √∫til para isso.
  
- **Trabalho**: Um evento aciona automaticamente o fluxo de trabalho, que cont√©m um trabalho. Em seguida, o trabalho usa etapas para controlar a ordem em que as a√ß√µes s√£o executadas. Exemplo de a√ß√µes executadas:
  
  - Executar testes
  
  - Executar um script `.R`


---

# Exemplo de workflow GHA 

.footnote[Fonte: [Reposit√≥rio  actions](https://github.com/r-lib/actions/tree/master/examples#quickstart-ci-workflow)]

.letramenor[
````yaml
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

name: R-CMD-check

jobs:
  R-CMD-check:
    runs-on: macOS-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2
      - uses: r-lib/actions/setup-r@v1
      - name: Install dependencies
        run: |
          install.packages(c("remotes", "rcmdcheck"))
          remotes::install_deps(dependencies = TRUE)
        shell: Rscript {0}
      - name: Check
        run: |
          options(crayon.enabled = TRUE)
          rcmdcheck::rcmdcheck(args = "--no-manual", error_on = "error")
        shell: Rscript {0}
````
]

---
# Integra√ß√£o cont√≠nua com GitHub Actions

- Recomenda√ß√£o: partir de um arquivo de workflow j√° existente, e alterar o que for necess√°rio. 

  - [Neste reposit√≥rio](https://github.com/r-lib/actions/tree/master/examples#readme), est√£o dispon√≠veis alguns exemplos de workflows de GitHub Actions que podemos usar com pacotes em R

- Os arquivos `.yaml` devem estar em um diret√≥rio espec√≠fico do pacote:  `pacote/.github/workflows/nome-do-workflow.yaml`

- O pacote usethis tamb√©m pode nos ajudar nisso. O c√≥digo a seguir cria o arquivo `.yaml` apresentado no √∫ltimo slide, usado para fazer uma checagem simples no pacote:


```r
usethis::use_github_action("check-release")
```

---
# Exemplo de workflow 

&lt;img src="img/action.png" width="60%" style="display: block; margin: auto;" /&gt;

.footnote[[Veja os logs do Exemplo!](https://github.com/beatrizmilz/materiais_estudo_R/runs/2328985236?check_suite_focus=true)]


---
# Regras para colocar um pacote no CRAN

&lt;!-- Antes desse slide o Caio vai escrever sobre o R-Hub --&gt;

Um pacote √© uma cole√ß√£o de c√≥digo, dados, documenta√ß√£o e testes que qualquer pessoa pode instalar em sua m√°quina.

Se quisermos criar apenas um conjunto de fun√ß√µes que provavelmente n√£o ser√£o utilizadas por muitas pessoas, podemos subir esse pacote para o GitHub e mant√™-lo l√° somente para
garantir controle de vers√£o.

Mas se quisermos que o m√°ximo n√∫mero poss√≠vel de pessoas tenha acesso ao nosso pacote, pode ser que precisemos subi-lo para o CRAN (Comprehensive R Archive Network). Neste caso precisaremos criar teste e documenta√ß√£o (em ingl√™s) para nosso pacote.

Use as fun√ß√µes `devtools::submit_cran()` e `usethis::use_release_issue()` para auxiliar no processo de submiss√£o do pacote para o CRAN.

---
class: middle, center, inverse


# Resumo

---

# Etapas iniciais

- Criar um pacote usando a fun√ß√£o `usethis::create_package("~/caminho/ate/o/nomepacote")`

- No arquivo DESCRIPTION, adicionar o nome de quem criou o pacote, al√©m do t√≠tulo e descri√ß√£o do pacote.

- Adicionar uma licen√ßa com `usethis::use_**_licence()`

- Versionar o projeto usando `usethis::use_git()`

- Crie um reposit√≥rio no GitHub onde esse pacote ser√° versionado utilizando `usethis::use_github()`

- Para preparar o pacote para receber testes, use `usethis::use_testthat()` 

- Para criar o arquivo README, use a fun√ß√£o `usethis::use_readme_rmd()`

- Para criar um site para o pacote, use a fun√ß√£o `usethis::use_pkgdown()`

---

# Fun√ß√µes para repetir com frequ√™ncia


- `devtools::document()`: atualiza a documenta√ß√£o e o arquivo NAMESPACE

- `devtools::load_all()`: simula o processo de instala√ß√£o e carregamento do pacote. As fun√ß√µes criadas ficam dispon√≠veis para uso

- `devtools::check()`: verifica se o pacote est√° funcionando. Pode apresentar erros, avisos e notas. Leia as mensagens no console :)


- Quando necess√°rio:

  - `usethis::build_readme()`: atualizar o `README.md`

  - `pkgdown::build_site()`: atualizar o site do pacote

---

# Desenvolvendo fun√ß√µes

- Criar fun√ß√µes: a fun√ß√£o `usethis::use_r("nome-do-arquivo")` cria o arquivo onde as fun√ß√µes devem ser escritas

- Declare as depend√™ncias usando:

  - pipe `%&gt;%`: `usethis::use_pipe()` + `devtools::document()` + `devtools::load_all()`
  
  - Pacotes instalados via CRAN: `usethis::use_package("nome_do_pacote")`
  
  - Pacotes instalados via GitHub: `usethis::use_dev_package("nome_do_pacote")`
  
- Documente suas fun√ß√µes no arquivo `.R`

- Crie o arquivo de testes usando `usethis::use_test("nome-do-arquivo")` e escreva testes para as fun√ß√µes presentes nesse arquivo



---
# Refer√™ncias  e materiais para estudo

- [Zen do R](https://curso-r.github.io/zen-do-r/), livro em desenvolvimento pela Curso-R.

- [R Packages](https://r-pkgs.org), livro aprofundado sobre desenvolvimento de pacotes.

- [R for Data Science - cap√≠tulo sobre Func√µes](https://r4ds.had.co.nz/functions.html)

- [Materiais da R-Ladies SP sobre a Hacktoberfest 2020](https://r-ladies-sao-paulo.github.io/2020-hacktoberfest/).

- [Folha de dicas do Git em Portugu√™s](https://training.github.com/downloads/pt_BR/github-git-cheat-sheet/)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
